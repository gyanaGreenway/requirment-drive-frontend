<div class="dashboard-container">
  <!-- Sidebar -->
  <aside class="sidebar" [class.collapsed]="sidebarCollapsed">
    <button class="sidebar-toggle" (click)="toggleSidebar()" title="Toggle Sidebar">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="3" width="7" height="18" rx="2" stroke="currentColor" stroke-width="2" [attr.fill]="sidebarCollapsed ? 'none' : 'currentColor'" [attr.fill-opacity]="sidebarCollapsed ? '0' : '0.3'"/>
        <rect x="13" y="3" width="8" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
      </svg>
    </button>
    <div class="logo-section">
      <div class="logo-icon">üìä</div>
      <h2 class="logo" *ngIf="!sidebarCollapsed">RecruitmentDrive</h2>
    </div>
    <nav>
      <ul class="nav-list">
        <li *ngFor="let item of navItems"
            [class.nav-group]="item.children?.length"
            [class.expanded]="item.children?.length && isExpanded(item)"
            [class.active]="!item.children?.length && isItemActive(item)"
            [class.current]="item.children?.length && isItemActive(item)">
          <a *ngIf="!item.children?.length"
             [routerLink]="item.route"
             class="nav-link"
             routerLinkActive="active"
             [routerLinkActiveOptions]="{ exact: item.exact ?? false }"
             [attr.title]="sidebarCollapsed ? item.label : null">
            <span class="icon"><i class="bi" [ngClass]="item.icon"></i></span>
            <span class="text" *ngIf="!sidebarCollapsed">{{ item.label }}</span>
          </a>

          <button *ngIf="item.children?.length"
                  type="button"
                  class="nav-link nav-group-btn"
                  (click)="toggleSection(item)"
                  [attr.aria-expanded]="isExpanded(item)"
                  [attr.title]="sidebarCollapsed ? item.label : null">
            <span class="icon"><i class="bi" [ngClass]="item.icon"></i></span>
            <span class="text" *ngIf="!sidebarCollapsed">{{ item.label }}</span>
            <span class="chevron" *ngIf="!sidebarCollapsed">
              <i class="bi" [ngClass]="isExpanded(item) ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
            </span>
          </button>

          <ul *ngIf="item.children?.length && !sidebarCollapsed" class="nav-submenu" [class.expanded]="isExpanded(item)">
            <li *ngFor="let child of item.children" [class.active]="isItemActive(child)">
              <a [routerLink]="child.route"
                 class="nav-sublink"
                 routerLinkActive="active"
                 [routerLinkActiveOptions]="{ exact: child.exact ?? false }"
                 [class.active]="isItemActive(child)"
                 [attr.title]="child.label">
                <span class="submenu-bullet"><i class="bi" [ngClass]="child.icon || 'bi-dot'"></i></span>
                <span class="submenu-text">{{ child.label }}</span>
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Session Expiry Banner -->
    <div *ngIf="showSessionBanner" class="alert alert-warning d-flex align-items-center" style="margin: 0 1rem 1rem 1rem;">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <div>
        Your session will expire in <strong>{{ sessionMinutesLeft }}</strong> minute{{ sessionMinutesLeft === 1 ? '' : 's' }}. Please save your work.
      </div>
    </div>
    <!-- Top Navigation / Header -->
    <header class="topbar">
      <div class="header-left">
        <h1>Dashboard</h1>
        <p class="subtitle">Welcome to your recruitment management system</p>
      </div>
      <div class="user-info">
        <div class="notification-badge">
          <i class="bi bi-bell"></i>
          <span class="badge">3</span>
        </div>
        <div class="user-profile" (click)="toggleDropdown()">
          <div class="profile-avatar">{{ getUserInitials() }}</div>
          <div class="user-details">
            <span class="user-name">{{ getUserName() }}</span>
            <span class="user-role">{{ getUserRole() }}</span>
          </div>
          <i class="bi bi-chevron-down dropdown-icon"></i>
        </div>
        <!-- Profile Dropdown -->
        <div class="profile-dropdown" [class.show]="showDropdown">
          <div class="dropdown-header">
            <div class="dropdown-avatar">{{ getUserInitials() }}</div>
            <div class="dropdown-user-info">
              <div class="dropdown-name">{{ getUserName() }}</div>
              <div class="dropdown-email">{{ getUserEmail() }}</div>
            </div>
          </div>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" (click)="navigateToProfile()">
            <i class="bi bi-person"></i>
            <span>My Profile</span>
          </a>
          <a class="dropdown-item" (click)="navigateToSettings()">
            <i class="bi bi-gear"></i>
            <span>Settings</span>
          </a>
          <a class="dropdown-item" (click)="navigateToChangePassword()">
            <i class="bi bi-key"></i>
            <span>Change Password</span>
          </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item logout-item" (click)="logout()">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
          </a>
        </div>
      </div>
    </header>

    <!-- Dashboard Content -->
    <section class="content">
      <!-- Show overview only when on dashboard root -->
      <div *ngIf="isDashboardRoot()">
        <!-- Welcome Section -->
        <div class="welcome-section">
          <h2>Your Recruitment Overview</h2>
          <p>Track and manage your recruitment pipeline at a glance</p>
        </div>

        <!-- Stats Cards Grid -->
        <div class="stats-grid">
          <div class="stat-card stat-card-jobs">
            <div class="card-header-bg"></div>
            <div class="card-icon">
              <i class="bi bi-briefcase"></i>
            </div>
            <div class="card-content">
              <div class="card-value">{{ stats.totalJobs }}</div>
              <div class="card-label">Total Jobs</div>
            </div>
            <div class="card-footer">Active postings</div>
          </div>

          <div class="stat-card stat-card-active">
            <div class="card-header-bg"></div>
            <div class="card-icon">
              <i class="bi bi-lightning-charge"></i>
            </div>
            <div class="card-content">
              <div class="card-value">{{ stats.activeJobs }}</div>
              <div class="card-label">Active Jobs</div>
            </div>
            <div class="card-footer">Currently open</div>
          </div>

          <div class="stat-card stat-card-candidates">
            <div class="card-header-bg"></div>
            <div class="card-icon">
              <i class="bi bi-people"></i>
            </div>
            <div class="card-content">
              <div class="card-value">{{ stats.totalCandidates }}</div>
              <div class="card-label">Candidates</div>
            </div>
            <div class="card-footer">In system</div>
          </div>

          <div class="stat-card stat-card-applications">
            <div class="card-header-bg"></div>
            <div class="card-icon">
              <i class="bi bi-file-earmark"></i>
            </div>
            <div class="card-content">
              <div class="card-value">{{ stats.totalApplications }}</div>
              <div class="card-label">Applications</div>
            </div>
            <div class="card-footer">Total received</div>
          </div>
        </div>

        <!-- Application Status Section -->
        <div class="status-section">
          <div class="section-header">
            <h3>Application Pipeline Status</h3>
            <p>Current application distribution across statuses</p>
          </div>
          <div class="status-grid">
            <div class="status-item status-new">
              <div class="status-icon">üì•</div>
              <div class="status-info">
                <div class="status-count">{{ stats.newApplications }}</div>
                <div class="status-label">New</div>
              </div>
              <div class="status-bar">
                <div class="progress-fill" [style.width.%]="(stats.newApplications / (stats.totalApplications || 1)) * 100"></div>
              </div>
            </div>
            <div class="status-item status-shortlisted">
              <div class="status-icon">‚≠ê</div>
              <div class="status-info">
                <div class="status-count">{{ stats.shortlistedApplications }}</div>
                <div class="status-label">Shortlisted</div>
              </div>
              <div class="status-bar">
                <div class="progress-fill" [style.width.%]="(stats.shortlistedApplications / (stats.totalApplications || 1)) * 100"></div>
              </div>
            </div>
            <div class="status-item status-hired">
              <div class="status-icon">‚úÖ</div>
              <div class="status-info">
                <div class="status-count">{{ stats.hiredApplications }}</div>
                <div class="status-label">Hired</div>
              </div>
              <div class="status-bar">
                <div class="progress-fill" [style.width.%]="(stats.hiredApplications / (stats.totalApplications || 1)) * 100"></div>
              </div>
            </div>
            <div class="status-item status-rejected">
              <div class="status-icon">‚ùå</div>
              <div class="status-info">
                <div class="status-count">{{ stats.rejectedApplications }}</div>
                <div class="status-label">Rejected</div>
              </div>
              <div class="status-bar">
                <div class="progress-fill" [style.width.%]="(stats.rejectedApplications / (stats.totalApplications || 1)) * 100"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="actions-section">
          <div class="section-header">
            <h3>Quick Actions</h3>
            <p>Manage your recruitment workflow</p>
          </div>
          <div class="actions-grid">
            <a routerLink="/dashboard/jobs/create" class="action-btn action-create">
              <div class="btn-icon">
                <i class="bi bi-plus-circle"></i>
              </div>
              <div class="btn-content">
                <h4>Create Job</h4>
                <p>Post a new job opening</p>
              </div>
            </a>
            <a routerLink="/dashboard/candidates/create" class="action-btn action-add">
              <div class="btn-icon">
                <i class="bi bi-person-plus"></i>
              </div>
              <div class="btn-content">
                <h4>Add Candidate</h4>
                <p>Register a new candidate</p>
              </div>
            </a>
            <a routerLink="/dashboard/applications" class="action-btn action-view">
              <div class="btn-icon">
                <i class="bi bi-file-earmark-text"></i>
              </div>
              <div class="btn-content">
                <h4>View Applications</h4>
                <p>Review all applications</p>
              </div>
            </a>
          </div>
        </div>

        <!-- Recent Job Applications Table -->
        <div class="applications-section">
          <div class="section-header">
            <h3>Recent Job Applications</h3>
            <p>Latest applications from candidates</p>
          </div>
          <div class="table-wrapper">
            <div *ngIf="recentLoading" class="table-loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <div *ngIf="recentError" class="alert alert-warning mb-0" role="alert">
              {{ recentError }}
            </div>
            <table class="applications-table" *ngIf="!recentLoading && !recentError">
              <thead>
                <tr>
                  <th>Job Title</th>
                  <th>Candidate</th>
                  <th>Applied Date</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let application of recentApplications" tabindex="0" (dblclick)="viewApplication(application.id)">
                  <td class="job-title-cell">
                    {{ getJobTitle(application) }}
                    <div class="text-muted" *ngIf="application.job?.department">
                      {{ application.job?.department }} ¬∑ {{ application.job?.location || '‚Äî' }}
                    </div>
                  </td>
                  <td class="candidate-name">
                    {{ getCandidateName(application) }}
                    <div class="text-muted" *ngIf="getCandidateEmail(application)">
                      {{ getCandidateEmail(application) }}
                    </div>
                  </td>
                  <td class="date-cell">{{ getAppliedDate(application) }}</td>
                  <td>
                    <span [ngClass]="getStatusBadgeClass(application.status)">
                      {{ getStatusLabel(application.status) }}
                    </span>
                  </td>
                  <td>
                    <button type="button" class="action-link" (click)="viewApplication(application.id)">
                      View
                    </button>
                  </td>
                </tr>
                <tr *ngIf="!recentApplications.length">
                  <td colspan="5" class="text-center text-muted py-4">
                    No applications available yet.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Router Outlet for Child Routes -->
      <router-outlet></router-outlet>
    </section>
  </main>
</div>
