<div class="container-fluid py-4 jobs-layout">
  <div class="page-header">
    <div class="page-title">
      <span class="eyebrow">Talent Pipeline</span>
      <h2 class="mb-2">
        <i class="bi bi-briefcase me-2"></i>Job Portfolio
      </h2>
      <p class="lead text-muted mb-0">
        Monitor every opening, keep candidates warm, and spot risk before roles go stale.
      </p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline-secondary me-2" type="button" (click)="loadJobs()" [disabled]="loading">
        <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
        Refresh
      </button>
      <button class="btn btn-primary" type="button" (click)="createJob()">
        <i class="bi bi-plus-circle me-2"></i>Create Job
      </button>
    </div>
  </div>

  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-label">Matching Roles</div>
      <div class="metric-value">{{ matchingJobsCount }}</div>
      <div class="metric-trend text-success" *ngIf="matchingJobsCount > 0">
        <i class="bi bi-check-circle-fill me-1"></i>{{ activeJobsCount }} currently live
      </div>
      <div class="metric-trend text-muted" *ngIf="matchingJobsCount === 0">
        Add a filter or create a new opening
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Total Roles</div>
      <div class="metric-value">{{ totalJobsCount }}</div>
      <div class="metric-trend text-muted">
        Across every department in scope
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Active Roles</div>
      <div class="metric-value">{{ activeJobsCount }}</div>
      <div class="metric-trend" [class.text-success]="activeJobsCount >= inactiveJobsCount" [class.text-warning]="activeJobsCount < inactiveJobsCount">
        {{ inactiveJobsCount }} inactive slots
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Closing Soon</div>
      <div class="metric-value">{{ closingSoonCount }}</div>
      <div class="metric-trend text-danger" *ngIf="closingSoonCount > 0">
        {{ closingSoonCount }} expiring within {{ closingSoonThresholdDays }} days
      </div>
      <div class="metric-trend text-muted" *ngIf="closingSoonCount === 0">
        No deadlines in the next {{ closingSoonThresholdDays }} days
      </div>
    </div>
  </div>

  <div class="search-card card mb-4">
    <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3">
      <div class="search-input flex-grow-1">
        <i class="bi bi-search"></i>
        <input
          type="text"
          class="form-control"
          placeholder="Search by title, department, or location"
          [(ngModel)]="searchTerm"
          (keyup.enter)="onSearch()"
        />
      </div>
      <div class="search-actions d-flex gap-2">
        <button class="btn btn-outline-primary" type="button" (click)="onSearch()">
          <i class="bi bi-filter me-2"></i>Apply
        </button>
        <button class="btn btn-link text-decoration-none" type="button" (click)="searchTerm = ''; onSearch()" [disabled]="!searchTerm">
          Clear
        </button>
      </div>
      <div class="search-meta text-muted" *ngIf="lastRefreshed">
        Updated {{ lastRefreshed | date: 'shortTime' }}
      </div>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ error }}
    <button type="button" class="btn-close" (click)="error = null"></button>
  </div>

  <div *ngIf="deleteError" class="alert alert-warning alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-1"></i>
    {{ deleteError }}
    <button type="button" class="btn-close" (click)="deleteError = null"></button>
  </div>

  <div *ngIf="loading" class="loading-state">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mt-3 mb-0">Fetching the latest openings…</p>
  </div>

  <div *ngIf="!loading" class="insights-grid">
    <div class="insight-card">
      <div class="insight-header">
        <h5>Closing Soon</h5>
        <span class="badge bg-danger-subtle text-danger" *ngIf="closingSoonCount > 0">{{ closingSoonCount }}</span>
      </div>
      <ng-container *ngIf="closingSoonJobs.length; else closingSoonEmpty">
        <ul class="list-unstyled insight-list mb-0">
          <li *ngFor="let job of closingSoonJobs; trackBy: trackByJobId" (contextmenu)="onRowRightClick($event, job)">
            <div class="list-title">{{ job.title }}</div>
            <div class="list-meta">
              <span><i class="bi bi-calendar-event me-1"></i>{{ job.closingDate | date: 'MMM d' }}</span>
              <span><i class="bi bi-geo-alt me-1"></i>{{ job.location }}</span>
            </div>
          </li>
        </ul>
      </ng-container>
      <ng-template #closingSoonEmpty>
        <p class="text-muted mb-0">No closing dates inside the two-week window.</p>
      </ng-template>
    </div>

    <div class="insight-card">
      <div class="insight-header">
        <h5>Department Mix</h5>
      </div>
      <ng-container *ngIf="departmentBreakdown.length; else deptEmpty">
        <ul class="list-unstyled insight-list mb-0">
          <li *ngFor="let entry of departmentBreakdown; trackBy: trackByLabel">
            <div class="list-title">{{ entry.label }}</div>
            <div class="list-meta">
              <span>{{ entry.count }} roles</span>
              <span>{{ entry.percentage }}%</span>
            </div>
          </li>
        </ul>
      </ng-container>
      <ng-template #deptEmpty>
        <p class="text-muted mb-0">No department insights yet.</p>
      </ng-template>
    </div>

    <div class="insight-card">
      <div class="insight-header">
        <h5>Location Spread</h5>
      </div>
      <ng-container *ngIf="locationBreakdown.length; else locationEmpty">
        <ul class="list-unstyled insight-list mb-0">
          <li *ngFor="let entry of locationBreakdown; trackBy: trackByLabel">
            <div class="list-title">{{ entry.label }}</div>
            <div class="list-meta">
              <span>{{ entry.count }} roles</span>
              <span>{{ entry.percentage }}%</span>
            </div>
          </li>
        </ul>
      </ng-container>
      <ng-template #locationEmpty>
        <p class="text-muted mb-0">No location insights yet.</p>
      </ng-template>
    </div>

    <div class="insight-card">
      <div class="insight-header">
        <h5>Recently Posted</h5>
      </div>
      <ng-container *ngIf="recentlyPostedJobs.length; else recentEmpty">
        <ul class="list-unstyled insight-list mb-0">
          <li *ngFor="let job of recentlyPostedJobs; trackBy: trackByJobId" (contextmenu)="onRowRightClick($event, job)">
            <div class="list-title">{{ job.title }}</div>
            <div class="list-meta">
              <span><i class="bi bi-clock-history me-1"></i>{{ job.postedDate | date: 'MMM d' }}</span>
              <span><i class="bi bi-briefcase me-1"></i>{{ job.department }}</span>
            </div>
          </li>
        </ul>
      </ng-container>
      <ng-template #recentEmpty>
        <p class="text-muted mb-0">Postings will appear here after refresh.</p>
      </ng-template>
    </div>
  </div>

  <div *ngIf="!loading && filteredJobs.length > 0" class="job-grid">
    <div
      class="job-card"
      *ngFor="let job of filteredJobs; trackBy: trackByJobId"
      (contextmenu)="onRowRightClick($event, job)"
    >
      <div class="job-card-header">
        <span class="badge" [class.bg-success-subtle]="job.isActive" [class.text-success]="job.isActive" [class.bg-secondary-subtle]="!job.isActive" [class.text-muted]="!job.isActive">
          {{ job.isActive ? 'Active' : 'Inactive' }}
        </span>
        <div class="job-card-actions">
          <button class="btn btn-outline-primary btn-sm" type="button" (click)="selectedJob = job; shareJob()">
            <i class="bi bi-send"></i>
          </button>
        </div>
      </div>
      <h5 class="job-card-title">{{ job.title }}</h5>
      <p class="job-card-subtitle">{{ job.department }} • {{ job.location }}</p>
      <div class="job-card-body">
        <div class="job-meta">
          <span><i class="bi bi-calendar-plus me-1"></i>{{ job.postedDate | date: 'MMM d, y' }}</span>
          <span *ngIf="job.closingDate"><i class="bi bi-calendar2-x me-1"></i>Closes {{ job.closingDate | date: 'MMM d' }}</span>
          <span *ngIf="job.salary"><i class="bi bi-currency-dollar me-1"></i>{{ job.salary | number }}</span>
          <span *ngIf="!job.salary && job.salaryRange"><i class="bi bi-currency-dollar me-1"></i>{{ job.salaryRange }}</span>
        </div>
        <p class="job-description" *ngIf="job.description">
          {{ job.description | slice:0:180 }}<span *ngIf="(job.description || '').length > 180">…</span>
        </p>
      </div>
      <div class="job-card-footer">
        <div class="job-tags" *ngIf="job.requirements?.length">
          <span class="badge rounded-pill bg-light text-muted" *ngFor="let req of job.requirements | slice:0:3">{{ req }}</span>
          <span class="badge rounded-pill bg-light text-muted" *ngIf="(job.requirements?.length ?? 0) > 3">+{{ (job.requirements?.length ?? 0) - 3 }} more</span>
        </div>
        <div class="job-actions">
          <button class="btn btn-outline-primary btn-sm" type="button" (click)="viewJob(job.id)">
            <i class="bi bi-eye me-1"></i>View
          </button>
          <button class="btn btn-outline-secondary btn-sm" type="button" (click)="editJob(job.id)">
            <i class="bi bi-pencil me-1"></i>Edit
          </button>
          <button class="btn btn-outline-danger btn-sm" type="button" (click)="promptDelete(job)">
            <i class="bi bi-trash me-1"></i>Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!loading && filteredJobs.length === 0" class="empty-state card">
    <div class="card-body text-center py-5">
      <i class="bi bi-search" aria-hidden="true"></i>
      <h5 class="mt-3">No roles match your filters</h5>
      <p class="text-muted mb-4">Adjust your search or create a new opening to keep momentum.</p>
      <div class="d-flex justify-content-center gap-2">
        <button class="btn btn-outline-secondary" type="button" (click)="searchTerm = ''; onSearch()">Clear Filters</button>
        <button class="btn btn-primary" type="button" (click)="createJob()">
          <i class="bi bi-plus-circle me-2"></i>Create Job
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="pagedResult && pagedResult.totalPages > 1" class="pagination-wrapper">
    <nav>
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="!pagedResult.hasPreviousPage">
          <button class="page-link" type="button" (click)="onPageChange(currentPage - 1)" [disabled]="!pagedResult.hasPreviousPage">
            Previous
          </button>
        </li>
        <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
          <button class="page-link" type="button" (click)="onPageChange(page)">{{ page }}</button>
        </li>
        <li class="page-item" [class.disabled]="!pagedResult.hasNextPage">
          <button class="page-link" type="button" (click)="onPageChange(currentPage + 1)" [disabled]="!pagedResult.hasNextPage">
            Next
          </button>
        </li>
      </ul>
    </nav>
    <p class="text-center text-muted mt-2 mb-0">
      Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ currentPage * pageSize > pagedResult.totalCount ? pagedResult.totalCount : currentPage * pageSize }}
      of {{ pagedResult.totalCount }} roles
    </p>
  </div>
</div>

<div *ngIf="showContextMenu"
     class="context-menu"
     [style.left.px]="contextMenuX"
     [style.top.px]="contextMenuY"
     (click)="$event.stopPropagation()">
  <div class="context-menu-header">
    <i class="bi bi-briefcase-fill"></i>
    <span>{{ selectedJob?.title }}</span>
  </div>
  <div class="context-menu-divider"></div>
  <button class="context-menu-item" type="button" (click)="shareJob()">
    <i class="bi bi-share-fill"></i>
    <span>Share Job</span>
  </button>
  <button class="context-menu-item" type="button" (click)="generateLink()">
    <i class="bi bi-link-45deg"></i>
    <span>Generate Link</span>
  </button>
</div>

<div *ngIf="showDeleteConfirm" class="confirm-overlay" role="dialog" aria-modal="true" aria-live="assertive">
  <div class="confirm-card">
    <div class="confirm-icon">
      <i class="bi bi-exclamation-triangle-fill"></i>
    </div>
    <h5 class="confirm-title">Delete Job?</h5>
    <p class="confirm-text">
      <strong>{{ jobPendingDelete?.title || 'This job' }}</strong> will be removed permanently. This action cannot be undone.
    </p>
    <div class="confirm-meta" *ngIf="jobPendingDelete">
      <span><i class="bi bi-geo-alt me-1"></i>{{ jobPendingDelete.location }}</span>
      <span><i class="bi bi-briefcase me-1"></i>{{ jobPendingDelete.department }}</span>
    </div>
    <div class="confirm-actions">
      <button class="btn btn-outline-secondary" type="button" (click)="cancelDelete()" [disabled]="deleteInProgress">
        Cancel
      </button>
      <button class="btn btn-danger" type="button" (click)="confirmDelete()" [disabled]="deleteInProgress">
        <span *ngIf="deleteInProgress" class="spinner-border spinner-border-sm me-2"></span>
        Delete
      </button>
    </div>
    <div *ngIf="deleteError" class="mt-3 small text-warning">
      <i class="bi bi-info-circle me-1"></i>{{ deleteError }}
    </div>
  </div>
</div>

