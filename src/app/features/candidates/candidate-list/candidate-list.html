<div class="container-fluid py-4 candidates-layout">
  <div class="page-header">
    <div class="title-group">
      <span class="eyebrow">Candidate Bench</span>
      <h2 class="mb-1">
        <i class="bi bi-people me-2"></i>Talent Directory
      </h2>
      <p class="lead text-muted mb-0">Curate a polished slate of talent with resume-ready profiles and focused skill coverage.</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline-secondary" type="button" (click)="loadCandidates()" [disabled]="loading">
        <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
        Refresh
      </button>
      <button class="btn btn-primary" type="button" (click)="createCandidate()">
        <i class="bi bi-plus-circle me-2"></i>Add Candidate
      </button>
    </div>
  </div>

  <div class="metrics-grid">
    <div class="metric-card">
      <span class="metric-label">Matching Profiles</span>
      <span class="metric-value">{{ matchingCandidatesCount }}</span>
      <span class="metric-sub">Visible in the current view</span>
    </div>
    <div class="metric-card">
      <span class="metric-label">Directory Total</span>
      <span class="metric-value">{{ totalCandidatesCount }}</span>
      <span class="metric-sub">Across the organization</span>
    </div>
    <div class="metric-card">
      <span class="metric-label">Resume Ready</span>
      <span class="metric-value">{{ resumeReadyCount }}</span>
      <span class="metric-sub">Profiles with shareable resumes</span>
    </div>
    <div class="metric-card">
      <span class="metric-label">Profile Enriched</span>
      <span class="metric-value">{{ profileSummaryCount }}</span>
      <span class="metric-sub">With narrative summaries</span>
    </div>
  </div>

  <div class="search-card card">
    <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3">
      <div class="search-input flex-grow-1">
        <i class="bi bi-search"></i>
        <input
          type="text"
          class="form-control"
          placeholder="Search by name, email, or skill keywords"
          [(ngModel)]="searchTerm"
          (keyup.enter)="onSearch()"
        />
      </div>
      <div class="search-actions d-flex gap-2">
        <button class="btn btn-outline-primary" type="button" (click)="onSearch()">
          Apply
        </button>
        <button class="btn btn-link text-decoration-none" type="button" (click)="clearSearch()" [disabled]="!searchTerm">
          Clear
        </button>
      </div>
      <div class="search-meta text-muted" *ngIf="lastRefreshed">
        Updated {{ lastRefreshed | date: 'shortTime' }}
      </div>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ error }}
    <button type="button" class="btn-close" (click)="error = null"></button>
  </div>

  <div *ngIf="loading" class="loading-state">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted small mt-3 mb-0">Refreshing candidate roster…</p>
  </div>

  <div *ngIf="!loading" class="insights-grid">
    <div class="insight-card">
      <div class="insight-header">
        <h5 class="insight-title">Top Skills</h5>
      </div>
      <ng-container *ngIf="topSkills.length; else skillsEmpty">
        <ul class="list-unstyled insight-list mb-0">
          <li *ngFor="let skill of topSkills; trackBy: trackBySkill">
            <span class="badge rounded-pill bg-light text-secondary">{{ skill.label }}</span>
            <span class="skill-count">{{ skill.count }} profiles</span>
          </li>
        </ul>
      </ng-container>
      <ng-template #skillsEmpty>
        <p class="text-muted small mb-0">Skill insights will appear once profiles are enriched.</p>
      </ng-template>
    </div>

    <div class="insight-card">
      <div class="insight-header">
        <h5 class="insight-title">Location Spread</h5>
      </div>
      <ng-container *ngIf="locationBreakdown.length; else locationEmpty">
        <ul class="list-unstyled insight-list mb-0">
          <li *ngFor="let item of locationBreakdown">
            <span class="location-label">{{ item.label }}</span>
            <span class="location-meta">{{ item.count }} • {{ item.percentage }}%</span>
          </li>
        </ul>
      </ng-container>
      <ng-template #locationEmpty>
        <p class="text-muted small mb-0">Assign city details to see regional coverage.</p>
      </ng-template>
    </div>

    <div class="insight-card profile-health">
      <div class="insight-header">
        <h5 class="insight-title">Profile Health</h5>
      </div>
      <ul class="list-unstyled mb-0">
        <li>
          <span>Resume headline</span>
          <span>{{ headlineCount }} prepared</span>
        </li>
        <li>
          <span>Profile summary</span>
          <span>{{ profileSummaryCount }} written</span>
        </li>
        <li>
          <span>Resume links</span>
          <span>{{ resumeReadyCount }} ready</span>
        </li>
      </ul>
    </div>
  </div>

  <div *ngIf="!loading && candidates.length > 0" class="candidate-grid">
    <div class="candidate-card" *ngFor="let candidate of candidates; trackBy: trackByCandidate">
      <div class="candidate-card-header">
        <div class="avatar">{{ getInitials(candidate) }}</div>
        <div class="identity">
          <h5>{{ candidate.firstName }} {{ candidate.lastName }}</h5>
          <div class="identity-meta">
            <span><i class="bi bi-envelope me-1"></i>{{ candidate.email }}</span>
            <span *ngIf="candidate.phone"><i class="bi bi-telephone me-1"></i>{{ candidate.phone }}</span>
          </div>
        </div>
        <div class="headline" *ngIf="candidate.resumeHeadline; else noHeadline">
          <span class="badge bg-primary-subtle text-primary">{{ candidate.resumeHeadline }}</span>
        </div>
        <ng-template #noHeadline>
          <span class="badge bg-light text-muted">Headline pending</span>
        </ng-template>
      </div>

      <div class="candidate-card-body">
        <p class="summary" *ngIf="getProfileSummarySnippet(candidate); else noSummary">
          {{ getProfileSummarySnippet(candidate) }}
        </p>
        <ng-template #noSummary>
          <p class="summary text-muted">Add a short profile narrative to spotlight this candidate.</p>
        </ng-template>

        <div class="skills" *ngIf="getSkillChips(candidate).length">
          <span class="badge rounded-pill bg-light text-secondary" *ngFor="let skill of getSkillChips(candidate)">{{ skill }}</span>
          <span class="badge rounded-pill bg-light text-secondary" *ngIf="getAdditionalSkillCount(candidate) > 0">+{{ getAdditionalSkillCount(candidate) }} more</span>
        </div>
      </div>

      <div class="candidate-card-footer">
        <div class="links" *ngIf="candidate.resumeUrl">
          <a [href]="candidate.resumeUrl" target="_blank" rel="noopener" class="link-resume">
            <i class="bi bi-file-earmark-text me-1"></i>Resume
          </a>
        </div>
        <div class="actions">
          <button class="btn btn-outline-primary btn-sm" type="button" (click)="viewCandidate(candidate.id)">
            <i class="bi bi-eye me-1"></i>View
          </button>
          <button class="btn btn-outline-secondary btn-sm" type="button" (click)="editCandidate(candidate.id)">
            <i class="bi bi-pencil me-1"></i>Edit
          </button>
          <button class="btn btn-outline-danger btn-sm" type="button" (click)="deleteCandidate(candidate.id)">
            <i class="bi bi-trash me-1"></i>Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!loading && candidates.length === 0" class="empty-state card">
    <div class="card-body text-center py-5">
      <i class="bi bi-person-plus" aria-hidden="true"></i>
      <h5 class="mt-3">No profiles match yet</h5>
      <p class="text-muted small mb-4">Adjust your filters or add a new candidate to keep the pipeline moving.</p>
      <div class="d-flex justify-content-center gap-2">
        <button class="btn btn-outline-secondary" type="button" (click)="clearSearch()">Clear Filters</button>
        <button class="btn btn-primary" type="button" (click)="createCandidate()">
          <i class="bi bi-plus-circle me-2"></i>Add Candidate
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="pagedResult && pagedResult.totalPages > 1" class="pagination-wrapper">
    <nav>
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="!pagedResult.hasPreviousPage">
          <button class="page-link" type="button" (click)="onPageChange(currentPage - 1)" [disabled]="!pagedResult.hasPreviousPage">
            Previous
          </button>
        </li>
        <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
          <button class="page-link" type="button" (click)="onPageChange(page)">{{ page }}</button>
        </li>
        <li class="page-item" [class.disabled]="!pagedResult.hasNextPage">
          <button class="page-link" type="button" (click)="onPageChange(currentPage + 1)" [disabled]="!pagedResult.hasNextPage">
            Next
          </button>
        </li>
      </ul>
    </nav>
    <p class="text-center text-muted small mt-2 mb-0">
      Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ currentPage * pageSize > pagedResult.totalCount ? pagedResult.totalCount : currentPage * pageSize }}
      of {{ pagedResult.totalCount }} candidates
    </p>
  </div>
</div>
